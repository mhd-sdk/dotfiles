# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

MHDShell is a minimalist Wayland desktop shell built on [Quickshell](https://git.outfoxxed.me/outfoxxed/quickshell), a Qt6/QML framework for Linux desktop environments. It targets the Hyprland compositor.

## Build & Run

The project uses Nix Flakes. There are no traditional build steps, tests, or linters.

```bash
# Enter development environment
nix develop

# Build the package
nix build

# Run directly during development (from within nix develop)
quickshell -p /home/mhd/dev/mhdshell
```

The built package installs to `$out/bin/mhdshell` which wraps `quickshell -p` with the correct QML_IMPORT_PATH and QT_PLUGIN_PATH.

## Design Language

- **No rounding** — `radius: 0` everywhere, legacy terminal aesthetic
- **Font** — text uses `font.family: Settings.font` (`"Terminess Nerd Font Mono"`), icons use `font.family: Settings.iconFont` (`"Cozette"`). Never hardcode font names. Both are defined in `Settings.qml`. `Theme.qml` is generated by matugen and must not store non-color data.
- **Text rendering** — always set `renderType: Text.NativeRendering`, `font.hintingPreference: Font.PreferFullHinting`, `antialiasing: false`
- **Font size** — `font.pixelSize: 16` for all text. Exception: large decorative icon glyphs used as empty-state placeholders (e.g. 48px).
- **Colors** — exclusively from `Theme` singleton (Material Design 3 dark palette)

## Architecture

### Entry Point
`shell.qml` — Creates a `ShellRoot` that spawns a `Bar` instance per screen using Quickshell's `Variants` + `Quickshell.screens`.

### Module Structure
- `modules/bar/` — Status bar: `Bar.qml` (PanelWindow, 25px top) → `BarLeft.qml` (workspaces) + `BarCenter.qml` (clock) + `BarRight.qml` (CPU temp, IP, menu button)
- `services/HyprlandData.qml` — Hyprland IPC data (clients, monitors, workspaces). Refreshes on every raw event.
- `services/Nmcli.qml` — NetworkManager interface (reserved for future menu).
- `utils/NetworkConnection.qml` — WiFi connection utility (reserved for future menu).

### Singletons
- **Theme** (`Theme.qml`) — Material Design 3 color tokens only. Generated by [matugen](https://github.com/InioX/matugen) and overwritten on each theme generation — never add non-color properties here.
- **Settings** (`Settings.qml`) — Persistent user settings: `font` property. Safe to edit manually.
- **GlobalState** (`GlobalState.qml`) — Empty placeholder for shared app state.
- **HyprlandData** (`services/HyprlandData.qml`) — Centralized Hyprland IPC data with normalized address matching.
- **Nmcli** (`services/Nmcli.qml`) — NetworkManager singleton: `networks` (AccessPoint list), `active` (current network), `wifiEnabled`, `scanning`.
- **NetworkConnection** (`utils/NetworkConnection.qml`) — Connection utility: `handleConnect(network, onPasswordNeeded)`, `connectWithPassword(network, password, onResult)`.

### Bar Architecture
`Bar.qml` is a 25px `PanelWindow` anchored top/left/right. It contains three sections:
- `BarLeft.qml` — workspace switcher
- `BarCenter.qml` — clock
- `BarRight.qml` — CPU temp, IP address, menu button (󰍜). No hover popouts. Menu to be implemented.

### Planned Features (Menu)
- WiFi — todo
- Bluetooth — todo
- Audio — todo
- Brightness — todo

### QML Import Conventions
- `qs` imports root-level singletons (Theme, GlobalState)
- `qs.modules.bar` imports bar components
- `qs.services` imports services (HyprlandData, Nmcli)
- `qs.utils` imports utilities (NetworkConnection)
- No `qmldir` files exist; Quickshell resolves imports by directory structure

### Key Patterns
- Components use `Process` + `StdioCollector` for IPC (hyprctl, nmcli)
- Workspace tracking is per-monitor (matches Hyprland's monitor-specific active workspace)
- Animations use custom Bezier easing curves (e.g. `[0.2, 1.0, 0.0, 1.0, 1.0, 1.0]`)
- `nmcli -t` output: colons in values are escaped as `\:` — parse with placeholder substitution (`replace(/\\:/g, "\x01").split(":").map(p => p.replace(/\x01/g, ":"))`)
- **WiFi connection flow** (from caelestia-shell pattern):
  1. `NetworkConnection.handleConnect(network, onPasswordNeeded)` — disconnects from current if different, then connects
  2. If secured + has saved profile → `Nmcli.connectToNetwork(ssid, "", bssid)` (no password, uses saved credentials)
  3. If secured + no saved profile → `Nmcli.connectToNetworkWithPasswordCheck()` → tries connection, if fails with password error → calls `onPasswordNeeded(network)` callback
  4. Password dialog → user enters password → `NetworkConnection.connectWithPassword(network, password, onResult)`
  5. `Nmcli.connectWireless()` sets `pendingConnection`, starts dual timers (500ms × 6 + 4s fallback)
  6. If BSSID + password → `createConnectionWithPassword()` → deletes existing profile, creates new with `nmcli connection add`, activates with `nmcli connection up`
  7. Otherwise → `nmcli device wifi connect <ssid> [password <pwd>]`
  8. Timers monitor `Nmcli.active.ssid` to detect success, call callback with result
  9. `nmcli monitor` process watches for network state changes → triggers `refreshOnConnectionChange()` → updates network list
- **Bluetooth connection flow** (using Quickshell.Bluetooth module):
  1. Uses Quickshell's built-in `Quickshell.Bluetooth` module (QML wrapper around BlueZ D-Bus)
  2. `Bluetooth` singleton provides: `defaultAdapter`, `devices` collection (reactive object map)
  3. `BluetoothAdapter` properties: `enabled`, `discovering`, `discoverable`, `pairable`, `name`
  4. `BluetoothDevice` properties: `connected`, `paired`, `bonded`, `trusted`, `blocked`, `name`, `address`, `icon`, `battery`
  5. Connection: `device.connected = true` (if already bonded) or `device.pair()` then `device.connected = true`
  6. Disconnect: `device.connected = false`
  7. Forget: `device.forget()` (unpairs device)
  8. All state updates are reactive through QML property bindings - no manual polling needed

### Reference Shell
`caelestia-shell/` is a cloned reference project (separate git repo) with a full-featured Quickshell implementation — useful for seeing patterns for notifications, media controls, system tray, brightness, bluetooth/wifi widgets, control center, launcher, OSD, session management, and other components not yet built in mhdshell.
